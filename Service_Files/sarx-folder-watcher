#!/usr/bin/env bash
# sarx-folder-watcher — watches user-defined folders and auto-encrypts new files

set -Eeuo pipefail
IFS=$'\n\t'

WATCH_FILE="${HOME}/.sarx_watchfolders"

canon_path() {
  python3 -c 'import sys,os; print(os.path.realpath(sys.argv[1]))' "$1"
}

add_folder() {
  local dir="$(canon_path "$1")"
  [[ -d "$dir" ]] || { echo "Not a directory: $dir" >&2; exit 1; }
  mkdir -p "$(dirname "$WATCH_FILE")"
  grep -Fxq "$dir" "$WATCH_FILE" 2>/dev/null || echo "$dir" >> "$WATCH_FILE"
  echo "Added: $dir"
}

remove_folder() {
  local dir="$(canon_path "$1")"
  if [[ -f "$WATCH_FILE" ]]; then
    grep -Fxv "$dir" "$WATCH_FILE" > "$WATCH_FILE.tmp" && mv "$WATCH_FILE.tmp" "$WATCH_FILE"
    echo "Removed: $dir"
  fi
}

list_folders() {
  if [[ -f "$WATCH_FILE" ]]; then
    echo "Watched folders:"
    cat "$WATCH_FILE"
  else
    echo "(no folders configured)"
  fi
}

run_watcher() {
  [[ -f "$WATCH_FILE" ]] || { echo "No folders to watch. Add some with: $0 add /path/to/folder" >&2; exit 1; }
  local dirs=()
  while read -r line; do
    [[ -d "$line" ]] && dirs+=("$line")
  done < "$WATCH_FILE"
  [[ ${#dirs[@]} -eq 0 ]] && { echo "No valid folders to watch." >&2; exit 1; }
  echo "Watching: ${dirs[*]}"
  inotifywait -m -e close_write,moved_to,create --format '%w%f' "${dirs[@]}" | while read -r file; do
    # Skip non-files or .vault outputs
    [[ "$file" == *.vault ]] && continue
    [[ ! -f "$file" ]] && continue
    # Wait for file to stabilize
    for i in {1..20}; do [[ -s "$file" ]] && break; sleep 0.05; done

    echo "[sarx-folder-watcher] encrypt: $file"
    # Encrypt and capture output
    out="$(sarx encrypt "$file" 2>&1)"
    # Try to extract password from output
    pw="$(echo "$out" | grep -a '^Password:' | sed 's/^Password: //')"
    if [[ -z "$pw" ]]; then
      # Fallback: first non-blank, non-✅ line
      pw="$(echo "$out" | grep -a -v '^✅' | grep -a -v '^$' | head -n1)"
    fi
    vault="${file}.vault"
    # Save password to sigilbook if all is well
    if [[ -n "$pw" && -f "$vault" ]]; then
      if printf '%s\n' "$pw" | sigilbook save "$vault" - >/dev/null 2>&1; then
        echo "[sarx-folder-watcher] password saved: $vault"
      else
        echo "[sarx-folder-watcher] failed to save password: $vault" >&2
      fi
    else
      echo "[sarx-folder-watcher] encrypt failed or no password: $file" >&2
      echo "$out"
    fi
  done
}

case "${1:-}" in
  add)
    [[ $# -eq 2 ]] || { echo "Usage: $0 add /path/to/folder" >&2; exit 1; }
    add_folder "$2"
    ;;
  remove|rm|delete)
    [[ $# -eq 2 ]] || { echo "Usage: $0 remove /path/to/folder" >&2; exit 1; }
    remove_folder "$2"
    ;;
  list|ls)
    list_folders
    ;;
  run|watch)
    run_watcher
    ;;
  *)
    echo "Usage:"
    echo "  $0 add /path/to/folder      # add a folder to watch"
    echo "  $0 remove /path/to/folder   # stop watching a folder"
    echo "  $0 list                     # list watched folders"
    echo "  $0 run                      # run the watcher (blocks)"
    ;;
esac